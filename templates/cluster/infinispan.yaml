---
{{- /*
This template will create a single Red Hat Data Grid cluster using the
`Infinispan` custom resource.
*/}}
{{- if .Values.infinispan.enabled -}}
apiVersion: infinispan.org/v1
kind: Infinispan
metadata:
  name: {{ .Values.infinispan.name }}
  {{- if .Values.monitoring.disablePrometheus }}
  annotations:
    infinispan.org/monitoring: 'false'
  {{- end }}
spec:
  replicas: {{ .Values.infinispan.replicas }}
  version: {{ .Values.infinispan.version }}
  service:
    type: DataGrid
  {{- if .Values.customConfig.enabled }}
  configMapName: {{ .Release.Name }}-datagrid-custom-config
  {{- end }}
  upgrades:
    type: {{ .Values.infinispan.upgradeType }}
  {{- if .Values.infinispan.disableConfigListener }}
  configListener:
    enabled: false
  {{- end }}
  expose:
    type: {{ .Values.expose.type }}
  {{- if eq "Route" .Values.expose.type }}
    host: {{ .Values.expose.hostname }}
  {{- else if and (eq "NodePort" .Values.expose.type) }}
    nodePort: {{ .Values.expose.port }}
  {{- else if eq "LoadBalancer" .Values.expose.type }}
    port: {{ default 11222 .Values.expose.port }}
  {{- end }}
  {{- if .Values.monitoring.enableJMX }}
  jmx:
    enabled: true
  {{- end }}
  {{- with .Values.resources }}
  container:
    memory: {{ .limits.memory }}:{{ .requests.memory }}
    cpu: {{ .limits.cpu }}:{{ .requests.cpu }}
  {{- end }}
  security:
    endpointAuthentication: {{ not .Values.authentication.disable }}
  {{- if .Values.authentication.credentialsSecretName }}
    endpointSecretName: {{ .Values.authentication.credentialsSecretName }}
  {{- end }}
{{- end -}}
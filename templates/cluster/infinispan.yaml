---
{{- /*
This template will create a single Red Hat Data Grid cluster using the
`Infinispan` custom resource.
*/}}
{{- if .Values.infinispan.enabled -}}
apiVersion: infinispan.org/v1
kind: Infinispan
metadata:
  name: {{ .Values.infinispan.name }}
  {{- if .Values.monitoring.disablePrometheus }}
  annotations:
    infinispan.org/monitoring: 'false'
  {{- end }}
spec:
  {{- if not (and .Values.autoscaling.enabled 
    (or .Values.autoscaling.cpuAverageUtilization
    .Values.autoscaling.memoryAverageUtilization)) }}
  replicas: {{ .Values.infinispan.replicas }}
  {{- end }}
  version: {{ .Values.infinispan.version }}
  service:
    type: DataGrid
    container:
  {{- with .Values.probes.readinessProbe }}
      readinessProbe:
        failureThreshold: {{ .failureThreshold }}
    {{- if .initialDelaySeconds }}
        initialDelaySeconds: {{ .initialDelaySeconds }}
    {{- end }}
        periodSeconds: {{ .periodSeconds }}
        successThreshold: {{ .successThreshold }}
        timeoutSeconds: {{ .timeoutSeconds }}
  {{- end }}
  {{- with .Values.probes.livenessProbe }}
      livenessProbe:
        failureThreshold: {{ .failureThreshold }}
    {{- if .initialDelaySeconds }}
        initialDelaySeconds: {{ .initialDelaySeconds }}
    {{- end }}
        periodSeconds: {{ .periodSeconds }}
        successThreshold: {{ .successThreshold }}
        timeoutSeconds: {{ .timeoutSeconds }}
  {{- end }}
  {{- with .Values.probes.startupProbe }}
      startupProbe:
        failureThreshold: {{ .failureThreshold }}
        initialDelaySeconds: {{ .initialDelaySeconds }}
        periodSeconds: {{ .periodSeconds }}
        successThreshold: {{ .successThreshold }}
        timeoutSeconds: {{ .timeoutSeconds }}
  {{- end }}
  {{- if .Values.customConfig.enabled }}
  configMapName: {{ .Release.Name }}-datagrid-custom-config
  {{- end }}
  upgrades:
    type: {{ .Values.infinispan.upgradeType }}
  {{- if .Values.infinispan.disableConfigListener }}
  configListener:
    enabled: false
  {{- end }}
  expose:
    type: {{ .Values.expose.type }}
  {{- if and (eq "Route" .Values.expose.type) .Values.expose.hostname }}
    host: {{ .Values.expose.hostname }}
  {{- else if and (eq "NodePort" .Values.expose.type) }}
    nodePort: {{ .Values.expose.port }}
  {{- else if eq "LoadBalancer" .Values.expose.type }}
    port: {{ default 11222 .Values.expose.port }}
  {{- end }}
  {{- if .Values.monitoring.enableJMX }}
  jmx:
    enabled: true
  {{- end }}
  container:
  {{- with .Values.resources }}
    memory: {{ .limits.memory }}:{{ .requests.memory }}
    cpu: {{ .limits.cpu }}:{{ .requests.cpu }}
  {{- end }}
  {{- with .Values.storage }}
    storage: {{ .size }}
    {{- if .ephemeral }}
    ephemeralStorage: true
    {{- else if and .storageClassName (not .ephemeral)  }}
    storageClassName: {{ .storageClassName }}
    {{- end }}
  {{- end }}
  security:
    endpointAuthentication: {{ not .Values.authentication.disable }}
  {{- if and .Values.authentication.credentialsSecretName
  (not .Values.authentication.disable) }}
    endpointSecretName: {{ .Values.authentication.credentialsSecretName }}
  {{- end }}
  {{- if .Values.encryption.disable }}
    endpointEncryption:
      type: None
  {{- end }}
  {{- if and .Values.credentialsStore.enabled .Values.credentialsStore.secretName }}
    credentialStoreSecretName: {{ .Values.credentialsStore.secretName }}
  {{- end }}
  {{- with .Values.authorization -}}
    {{- if .enabled }}
    authorization:
      enabled: true
      {{- if .customRoles.enabled }}
      roles:
        {{- range .customRoles.roles }}
        - name: {{ .name }}
          permissions:
          {{- range .permissions }}
            - {{ . }}
          {{- end }}
        {{- end }}
      {{- end }}
    {{- end }}
  {{- end }}
  {{- if .Values.logging }}
  logging:
    categories:
    {{- range $category, $level := .Values.logging }}
      {{ $category }}: {{ $level }}
    {{- end }}
  {{- end }}
  {{- with .Values.availability -}}
    {{- if .enabled }}
  affinity:
    podAntiAffinity:
      {{- if eq "preferred" .antiAffinitityType }}
      {{- $weight := 100 }}
      preferredDuringSchedulingIgnoredDuringExecution:
        {{- if .zone }}
        - weight: {{ $weight }}
          podAffinityTerm:
            {{- include "label-selector.zone" $ | nindent 12 }}
          {{- $weight = 90 -}}
        {{- end }}
        {{- if .hostname }}
        - weight: {{ $weight }}
          podAffinityTerm:
            {{- include "label-selector.hostname" $ | nindent 12 }}
        {{- end }}        
      {{- else if eq "required" .antiAffinitityType }}
      requiredDuringSchedulingIgnoredDuringExecution:
        {{- if .zone }}
        - {{ include "label-selector.zone" $ | indent 10 | trim }}
        {{- end }}
        {{- if .hostname }}
        - {{ include "label-selector.hostname" $ | indent 10 | trim }}
        {{- end }}
      {{- end }}
    {{- end }}
  {{- end }}
{{- end -}}